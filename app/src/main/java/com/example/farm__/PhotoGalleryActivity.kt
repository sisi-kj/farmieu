//package com.example.farm__
//
//import android.util.Log
//import android.app.TimePickerDialog
//import android.os.Bundle
//import android.widget.*
//import androidx.appcompat.app.AppCompatActivity
//import com.bumptech.glide.Glide
//import com.google.firebase.auth.FirebaseAuth
//import com.google.firebase.firestore.FirebaseFirestore
//import com.google.firebase.firestore.Query
//import java.util.*
//import androidx.appcompat.app.AlertDialog
//
//import android.util.Base64
//
//import android.graphics.BitmapFactory
//
//class PhotoGalleryActivity : AppCompatActivity() {
//
//    private lateinit var db: FirebaseFirestore
//    private lateinit var auth: FirebaseAuth
//    private lateinit var galleryLayout: LinearLayout
//    private lateinit var tvSelectedTime: TextView
//    private var selectedTime: String = "08:00"
//
//
//    override fun onCreate(savedInstanceState: Bundle?) {
//        super.onCreate(savedInstanceState)
//        setContentView(R.layout.activity_photo_gallery)
//
//        auth = FirebaseAuth.getInstance()
//        db = FirebaseFirestore.getInstance()
//
//        galleryLayout = findViewById(R.id.galleryLayout)
//        tvSelectedTime = findViewById(R.id.tvSelectedTime)
//        val btnPickTime = findViewById<Button>(R.id.btnPickTime)
//        val btnSaveTime = findViewById<Button>(R.id.btnSaveTime)
//
//        val email = auth.currentUser?.email ?: return
//        // üîπ Ï†ÄÏû•Îêú ÏãúÍ∞Ñ Î∂àÎü¨Ïò§Í∏∞
//        db.collection("users").document(email)
//            .get()
//            .addOnSuccessListener { snapshot ->
//                val savedTime = snapshot.getString("photoTime")
//                if (!savedTime.isNullOrBlank()) {
//                    selectedTime = savedTime
//                    tvSelectedTime.text = "ÏÑ†ÌÉùÎêú ÏãúÍ∞Ñ: $selectedTime"
//                }
//            }
//
//
//        db.collection("users").document(email)
//
//            .collection("photos")
//            .orderBy("timestamp", Query.Direction.DESCENDING)
//            .get()
//            .addOnSuccessListener { documents ->
//                for (doc in documents) {
//                    val base64 = doc.getString("imageBase64") ?: continue
//                    val pureBase64 = base64.substringAfter("base64,", "").replace("\\s".toRegex(), "")
//                    try {
//                        val decodedBytes = Base64.decode(pureBase64, Base64.DEFAULT)
//                        val bitmap = BitmapFactory.decodeByteArray(decodedBytes, 0, decodedBytes.size)
//
//                        val imageView = ImageView(this)
//                        imageView.layoutParams = LinearLayout.LayoutParams(
//                            LinearLayout.LayoutParams.MATCH_PARENT,
//                            400
//                        )
//                        imageView.scaleType = ImageView.ScaleType.CENTER_CROP
//                        imageView.setImageBitmap(bitmap)
//                        galleryLayout.addView(imageView)
//                    } catch (e: Exception) {
//                        e.printStackTrace()
//                        Log.e("PhotoGallery", "Base64 ÎîîÏΩîÎî© Ïã§Ìå®: ${e.message}")
//                    }
//                }
//            }
//            .addOnFailureListener {
//                Toast.makeText(this, "Ïù¥ÎØ∏ÏßÄ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ${it.message}", Toast.LENGTH_SHORT).show()
//            }
//
//
//        // üîπ ÏãúÍ∞Ñ ÏÑ†ÌÉù Î≤ÑÌäº
//        btnPickTime.setOnClickListener {
//            val now = Calendar.getInstance()
//            val hour = now.get(Calendar.HOUR_OF_DAY)
//            val min = now.get(Calendar.MINUTE)
//            val docRef = doc.reference
//            imageView.setOnLongClickListener {
//                AlertDialog.Builder(this)
//                    .setTitle("ÏÇ¨ÏßÑ ÏÇ≠Ï†ú")
//                    .setMessage("Ïù¥ ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")
//                    .setPositiveButton("ÏÇ≠Ï†ú") { _, _ ->
//                        docRef.delete()
//                    }
//                    .setNegativeButton("Ï∑®ÏÜå", null)
//                    .show()
//                true
//            }
//
//            TimePickerDialog(this, { _, h, m ->
//                selectedTime = String.format("%02d:%02d", h, m)
//                tvSelectedTime.text = "ÏÑ†ÌÉùÎêú ÏãúÍ∞Ñ: $selectedTime"
//            }, hour, min, true).show()
//        }
//
//        // üîπ Ï†ÄÏû• Î≤ÑÌäº
//        btnSaveTime.setOnClickListener {
//            db.collection("users").document(email)
//                .update("photoTime", selectedTime)
//                .addOnSuccessListener {
//                    Toast.makeText(this, "ÏÇ¨ÏßÑ Ï†ÄÏû• ÏãúÍ∞ÑÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§", Toast.LENGTH_SHORT).show()
//                }
//                .addOnFailureListener {
//                    Toast.makeText(this, "ÏãúÍ∞Ñ Ï†ÄÏû• Ïã§Ìå®: ${it.message}", Toast.LENGTH_SHORT).show()
//                }
//        }
//    }
//}
package com.example.farm__

import android.content.Intent
import android.util.Log
import android.app.TimePickerDialog
import android.os.Bundle
import android.widget.*
import androidx.appcompat.app.AppCompatActivity
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.Query
import java.util.*
import androidx.appcompat.app.AlertDialog
import android.util.Base64
import android.graphics.BitmapFactory
import java.text.SimpleDateFormat
import android.graphics.Color


class PhotoGalleryActivity : AppCompatActivity() {

    private lateinit var db: FirebaseFirestore
    private lateinit var auth: FirebaseAuth
    private lateinit var galleryLayout: LinearLayout
    private lateinit var tvSelectedTime: TextView
    private var selectedTime: String = "08:00"

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_photo_gallery)

        auth = FirebaseAuth.getInstance()
        db = FirebaseFirestore.getInstance()

        galleryLayout = findViewById(R.id.galleryLayout)
        tvSelectedTime = findViewById(R.id.tvSelectedTime)
        val btnPickTime = findViewById<Button>(R.id.btnPickTime)
        val btnSaveTime = findViewById<Button>(R.id.btnSaveTime)

        val email = auth.currentUser?.email ?: return

        // üîπ Ï†ÄÏû•Îêú ÏãúÍ∞Ñ Î∂àÎü¨Ïò§Í∏∞
        db.collection("users").document(email)
            .get()
            .addOnSuccessListener { snapshot ->
                val savedTime = snapshot.getString("photoTime")
                if (!savedTime.isNullOrBlank()) {
                    selectedTime = savedTime
                    tvSelectedTime.text = "ÏÑ†ÌÉùÎêú ÏãúÍ∞Ñ: $selectedTime"
                }
            }

        // üîπ ÏÇ¨ÏßÑ Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞
        db.collection("users").document(email)
            .collection("gallery")
            .orderBy("timestamp", Query.Direction.DESCENDING)
            .get()
            .addOnSuccessListener { documents ->
                for (doc in documents) {
                    val base64 = doc.getString("imageBase64") ?: continue
                    val timestamp = doc.getTimestamp("timestamp")
                    val dateText = timestamp?.toDate()?.let {
                        SimpleDateFormat("yyyy-MM-dd HH:mm", Locale.getDefault()).format(it)
                    } ?: "ÏãúÍ∞Ñ Ï†ïÎ≥¥ ÏóÜÏùå"

                    val pureBase64 = base64.substringAfter("base64,", "").replace("\\s".toRegex(), "")
                    val decodedBytes = Base64.decode(pureBase64, Base64.DEFAULT)
                    val bitmap = BitmapFactory.decodeByteArray(decodedBytes, 0, decodedBytes.size)

                    // üîπ Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉ ÏÉùÏÑ±
                    val card = LinearLayout(this).apply {
                        orientation = LinearLayout.VERTICAL
                        layoutParams = LinearLayout.LayoutParams(
                            LinearLayout.LayoutParams.MATCH_PARENT,
                            LinearLayout.LayoutParams.WRAP_CONTENT
                        ).apply { setMargins(0, 0, 0, 32) }
                    }

                    // üîπ ÏãúÍ∞Ñ ÌëúÏãú ÌÖçÏä§Ìä∏
                    val timestampView = TextView(this).apply {
                        text = dateText
                        textSize = 16f
                        setTextColor(Color.parseColor("#3E803F"))
                    }

                    // üîπ Ïù¥ÎØ∏ÏßÄ Î∑∞
                    val imageView = ImageView(this).apply {
                        layoutParams = LinearLayout.LayoutParams(
                            LinearLayout.LayoutParams.MATCH_PARENT,
                            400
                        )
                        scaleType = ImageView.ScaleType.CENTER_CROP
                        setImageBitmap(bitmap)
                    }

                    // üîπ ÏÇ≠Ï†ú Î≤ÑÌäº
                    val deleteButton = Button(this).apply {
                        text = "ÏÇ≠Ï†ú"
                        setBackgroundColor(Color.parseColor("#FFCDD2"))
                        setTextColor(Color.BLACK)
                        setOnClickListener {
                            doc.reference.delete()
                        }
                    }

                    card.addView(timestampView)
                    card.addView(imageView)
                    card.addView(deleteButton)

                    galleryLayout.addView(card)
                }
            }
            .addOnFailureListener {
                Toast.makeText(this, "Ïù¥ÎØ∏ÏßÄ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ${it.message}", Toast.LENGTH_SHORT).show()
            }

        // üîπ ÏãúÍ∞Ñ ÏÑ†ÌÉù Î≤ÑÌäº
        btnPickTime.setOnClickListener {
            val now = Calendar.getInstance()
            val hour = now.get(Calendar.HOUR_OF_DAY)
            val min = now.get(Calendar.MINUTE)

            TimePickerDialog(this, { _, h, m ->
                selectedTime = String.format("%02d:%02d", h, m)
                tvSelectedTime.text = "ÏÑ†ÌÉùÎêú ÏãúÍ∞Ñ: $selectedTime"
            }, hour, min, true).show()
        }

        // üîπ Ï†ÄÏû• Î≤ÑÌäº
        btnSaveTime.setOnClickListener {
            db.collection("users").document(email)
                .update("photoTime", selectedTime)
                .addOnSuccessListener {
                    Toast.makeText(this, "ÏÇ¨ÏßÑ Ï†ÄÏû• ÏãúÍ∞ÑÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§", Toast.LENGTH_SHORT).show()

                    // ‚úÖ FarmDashboardActivityÏùò ÌÉÄÏù¥Î®∏ Ïû¨Îì±Î°ù
                    sendBroadcast(Intent("RELOAD_PHOTO_TIMER"))
                    val intent = Intent("RELOAD_PHOTO_TIMER")
                    sendBroadcast(intent)
                }
                .addOnFailureListener {
                    Toast.makeText(this, "ÏãúÍ∞Ñ Ï†ÄÏû• Ïã§Ìå®: ${it.message}", Toast.LENGTH_SHORT).show()
                }
        }

    }
}
